include: /ci/jobs/.cond.yml

.latte-rules:
  rules:
    - !reference [.cond/on-merge-request, rules]

.no-latte-rules:  
  rules:
    - !reference [.cond/on-main, rules]
    - !reference [.cond/on-version-tag, rules]

.coverage/integration:
  stage: coverage
  image: ghcr.io/nordsecurity/nordvpn-linux/builder:1.0.0
  script:
    - $CI_PROJECT_DIR/ci/qa_test_coverage.sh
  dependencies: 
    - test/deb
    - test/deb-connect1
    - test/deb-connect2
    - test/deb-combinations
    - test/deb-firewall
    - test/deb-firewall6
    - test/deb-autoconnect1
    - test/deb-autoconnect2
    - test/deb-meshnet
    - test/deb-fileshare
  allow_failure: true
  coverage: '/Total coverage: (\d+\.\d+)%/'

coverage/integration-latte:
  extends: 
    - .coverage/integration
    - .latte-rules
  dependencies:
    - latte/deb-replay
    - latte/deb-connect1-replay
    - latte/deb-connect2-replay
    - latte/deb-combinations-replay
    - test/deb-manual
    - latte/deb-autoconnect1-replay
    - latte/deb-autoconnect2-replay
    - test/deb-meshnet
    - test/deb-fileshare

coverage/integration-regular:
  extends: 
    - .coverage/integration
    - .no-latte-rules

.coverage/combined:
  stage: coverage
  image: ghcr.io/nordsecurity/nordvpn-linux/builder:1.0.0
  script:
    - $CI_PROJECT_DIR/ci/combined_coverage.sh
  dependencies: 
    - test/cgo
    - test/deb
    - test/deb-connect1
    - test/deb-connect2
    - test/deb-combinations
    - test/deb-firewall
    - test/deb-firewall6
    - test/deb-autoconnect1
    - test/deb-autoconnect2
    - test/deb-meshnet
    - test/deb-fileshare
  allow_failure: true
  coverage: '/Total coverage: (\d+\.\d+)%/'

coverage/combined-latte:
  extends: 
    - .coverage/combined
    - .latte-rules
  dependencies:
    - latte/deb-replay
    - latte/deb-connect1-replay
    - latte/deb-connect2-replay
    - latte/deb-combinations-replay
    - test/deb-manual
    - latte/deb-autoconnect1-replay
    - latte/deb-autoconnect2-replay
    - test/deb-meshnet
    - test/deb-fileshare

coverage/combined-regular:
  extends: 
    - .coverage/combined
    - .no-latte-rules